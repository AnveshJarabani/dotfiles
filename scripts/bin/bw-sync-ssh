#!/bin/bash

# Sync all SSH keys from Bitwarden to ~/.ssh/

if [ -z "$BW_SESSION" ]; then
    echo "ERROR: BW_SESSION not set. Run: export BW_SESSION=\"\$(bw unlock --raw)\""
    exit 1
fi

echo "Syncing SSH keys from Bitwarden to ~/.ssh/..."
echo ""

# Get all SSH key items from Bitwarden
for item in $(bw list items --search "ssh-" 2>/dev/null | jq -r '.[] | select(.name | startswith("ssh-")) | .name'); do
    # Remove 'ssh-' prefix to get filename
    filename="${item#ssh-}"
    
    echo "Processing: $item → ~/.ssh/$filename"
    
    # Get key content and save to file
    bw get item "$item" 2>/dev/null | jq -r '.notes' > ~/.ssh/$filename
    
    if [ $? -eq 0 ]; then
        chmod 600 ~/.ssh/$filename
        echo "  ✓ Synced ~/.ssh/$filename"
    else
        echo "  ✗ Failed to sync $item"
    fi
done

echo ""
echo "✓ SSH keys synced!"
